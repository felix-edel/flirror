FROM python:3.8.1-alpine3.11

WORKDIR /opt

# NOTE (felix): Originally, I wanted to build the docker image with the
# released flirror version on PyPI. But, if we want to use automated docker
# builds on docker hub, we might keep the installation from sources so we
# are able to trigger builds whenever a change is merged to master (latest)
# or a tag is pushed (concrete release version).
# In the end it doesn't matter as the code-state is the same.
COPY . /opt

# Packages needed to build pillow
RUN apk add --no-cache --virtual .build-deps \
        build-base \
        libffi-dev \
        openssl-dev \
        python3-dev \
        py-pip \
        jpeg-dev \
        zlib-dev \
    # Upgrade pip, so we can use it directly to install flirror
    && pip install --upgrade pip \
    && pip install . \
    # Delete build dependencies
    && apk del .build-deps

# gunicorn is running on port 8000 by default
EXPOSE 8000

# Make gunicorn listen on all network interfaces (0.0.0.0) to make it
# reachable outside the docker container
CMD flirror-web -w 4 --bind 0.0.0.0:8000
