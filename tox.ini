[tox]
envlist = py36, dev

[testenv]
description = Running static code checks and unit tests
deps =
    flake8
    black
    freezegun
    pytest
    pytest-cov
    requests-mock
commands =
    # We must call pytest as module to make the coverage report work.
    # Otherwise, the coverage will always be 0%.
    {envpython} -m pytest \
        --cov=flirror --cov-report=term-missing --cov-report=html --cov-report=xml \
        --verbose {posargs}
    flake8
    black --check --diff .
    python setup.py sdist bdist_wheel
    flirror-crawler --help

[testenv:dev]
description = Development environment for Flirror
deps =
    {[testenv]deps}
commands =
usedevelop = true

[testenv:css]
description = Running CSS regression tests
deps =
    nodeenv
whitelist_externals =
    node
    npm
    sqlite3
# Add node JS installation to this virtual python environment
install_command =
    {toxinidir}/helpers/create-nodeenv.sh {opts} {packages}
setenv =
    FLASK_APP = flirror
    FLIRROR_SETTINGS = {toxinidir}/tests/testdata/test-settings.cfg
commands =
    # TODO This command fails when the test-database.sqlite file is already present
    bash -c 'sqlite3 test-database.sqlite < "{toxinidir}/tests/testdata/database-dump.sql"'
    bash -c 'flask run &'
    backstop test
    # TODO How to stop flask now?
